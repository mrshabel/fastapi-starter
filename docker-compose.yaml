services:
    api:
        container_name: fastapi-starter-api
        build: .
        ports:
            - 8000:8000
        depends_on:
            - nginx
            - redis
        volumes:
            - ./data:/mnt/data
        env_file:
            - .env.docker
        healthcheck:
            # ping application with curl fast-fail
            test: ["CMD", "curl", "-f", "http://localhost:8000/health-check"]
            interval: 30s
            timeout: 30s
            retries: 5
            start_period: 30s

    startup:
        # ephemeral container for running startup scripts
        container_name: fastapi-starter-startup
        build: .
        image: fastapi-starter-api
        command: bash -c "alembic upgrade head && python -m src.scripts.seed"
        env_file:
            - .env.docker
        volumes:
            - ./data:/mnt/data

    redis:
        container_name: fastapi-starter-redis
        image: redis:7-alpine

    nginx:
        container_name: fastapi-starter-nginx
        image: nginx
        ports:
            - 8080:80
            - 8443:443
        volumes:
            - ./nginx/nginx.conf:/etc/nginx/nginx.conf
            - ./nginx/certs:/etc/ssl
